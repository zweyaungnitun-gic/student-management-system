<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!--Last Update-->

<head th:replace="~{layouts/admin-layout :: head(pageTitle=${'Students | Admin Dashboard'})}"></head>

<body>
  <div class="dashboard-layout">

    <!-- Sidebar -->
    <th:block th:replace="~{layouts/admin-layout :: sidebar(currentPage=${'students'})}"></th:block>

    <div class="sidebar-overlay d-lg-none" data-sidebar-toggle></div>

    <!-- Main Section -->
    <div class="dashboard-main" style="width:100%; height:100%;">

      <!-- Full-width area (page-wrapper removed) -->
      <div class="dashboard-content" style="padding:0; margin:0; width:100%;">

        <!-- Use container-fluid so it expands full width beside sidebar -->
        <main class="container-fluid flex-grow-1" style="padding:0; margin:0;">

          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>生徒情報管理システム</title>

            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />


            <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

            <style>
              body {
                background-color: transparent;
                padding: 0;
                margin: 0;
                min-height: 100vh;
                width: 100vw;
              }


              .table tbody td a.action-icon {
                display: inline-flex;
                align-items: center;
                margin-right: 8px;
                white-space: nowrap;
              }


              .student-management {
                padding: 0;
              }

              .table-responsive {
                background-color: transparent;
                border-radius: 0;
                box-shadow: none !important;
                width: 100%;
              }


              /* Make action icons square with pagination color style */
              .action-icon {
                display: inline-flex;
                /* flex for centering */
                align-items: center;
                /* vertical center */
                justify-content: center;
                /* horizontal center */
                width: 36px;
                /* square width */
                height: 36px;
                /* square height */
                margin: 0 2px;
                /* spacing between buttons */
                border-radius: 0.25rem;
                /* optional rounded corners */
                font-size: 1rem;
                color: white;
                /* text/icon color */
                text-decoration: none;
                transition: background-color 0.2s, color 0.2s;
              }

              /* Make action icons square with background behind icon */
              .action-icon {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                margin: 0 2px;
                border-radius: 0.25rem;
                font-size: 1rem;
                text-decoration: none;
                transition: background-color 0.2s;
                color: white;
                /* Icon color stays visible */
              }

              .table {
                margin-bottom: 0;
                border-radius: 0;
                overflow: visible;
                width: 100%;
                table-layout: auto;
              }

              .title-header-row th {
                background: #0F6CBD;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0 0 0 0;
                border-bottom: 1px solid #0a58a0;
              }

              .title-header-row h4 {
                color: white;
                margin-bottom: 0 !important;
              }

              .filter-row th {
                background: white;
                color: black;
                padding-left: 0.25rem !important;
                border-radius: 0;
                border-bottom: 1px solid #dee2e6;
              }

              .filter-row th span {
                color: black;
              }

              .filter-control-group {
                display: flex;
                /* horizontal layout inside group */
                flex-direction: row;
                /* label + input in a row */
                align-items: center;
                /* vertically align label + input */
                gap: 0.5rem;
                /* small gap between label and input */
              }

              /* Make checkbox appear after label text */
              .filter-control-group.checkbox-group {
                flex-direction: row-reverse;
                /* Label first, checkbox after */
              }

              /* Inputs and select same height */
              .filter-control-group input[type="text"],
              .filter-control-group select {
                height: calc(1.5em + 0.5rem + 2px);
              }


              #nameSearchInput:hover {
                border-color: #1877F2 !important;
                box-shadow: 0 0 0 0.25rem rgba(24, 119, 242, 0.25) !important;
              }


              /* Make student name search input smaller */
              #studentFilterForm #nameSearchInput {
                width: 150px !important;
                /* force width */
                max-width: 150px !important;
                font-size: 0.85rem;
                padding: 0.25rem 0.5rem;
                border: 1px solid rgb(61, 56, 56);
              }


              #nameSearchInput::placeholder {
                color: black;
                /* Replace with your desired color */
                opacity: 1;
                /* ensures full color, not faded */
              }

              #studentFilterForm {
                display: flex;
                /* horizontal layout */
                flex-wrap: nowrap;
                /* prevent wrapping to next line */
                align-items: center;
                /* vertically center everything */
                gap: 3rem;
                /* spacing between items */
                margin: 0;
                padding: 10px;
              }

              #studentStatusFilter .filter-control-group {
                display: flex;
                flex-direction: row;
                /* horizontal */
                align-items: center;
                /* vertically center label and input */
                gap: 0.5rem;
                /* spacing between label and input */
                width: auto;
                /* optional: adjust width as needed */
              }


              #studentStatusFilter .filter-label {
                font-size: 16px;
                font-weight: 500;
                color: black;
              }

              #studentStatusFilter .multiselect-wrapper {
                position: relative;
              }

              #studentStatusFilter .multiselect-input {
                width: 150px;
                font-size: 0.85rem;
                padding: 0.25rem 0.5rem;
                font-size: 12px;
                border: 1px solid rgb(61, 56, 56);
                border-radius: 6px;
                background-color: white;
                cursor: pointer;
                color: black;
              }

              #studentStatusFilter .multiselect-input:focus {
                outline: none;
                border-color: rgb(248, 244, 244);
              }

              #studentStatusFilter .dropdown-arrow {
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 12px;
                color: #0B5ED7;
                pointer-events: none;
              }

              /* dropdown */
              #studentStatusFilter .multiselect-dropdown {
                position: absolute;
                top: 105%;
                left: 0;
                width: 100%;
                background: white;
                border: 1px solid #ccc;
                border-radius: 6px;
                box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.1);
                display: none;
                z-index: 999;
                padding: 6px 0;
              }

              #studentStatusFilter .multiselect-dropdown label {
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                font-size: 14px;
                cursor: pointer;
              }

              #studentStatusFilter .multiselect-dropdown label:hover {
                background-color: #eef1f4;
              }

              #studentStatusFilter {
                position: relative;
                z-index: 20000;
                /* wrapper stacking context */
                overflow: visible;
                /* ensure dropdown is not clipped */
              }

              #studentStatusFilter .multiselect-dropdown {
                position: absolute;
                /* already set */
                top: 100%;
                /* right below input */
                left: 0;
                width: 100%;
                z-index: 30000 !important;
                /* above header and table */
              }


              #statusFilter[multiple] {
                height: 32px !important;
                overflow-y: auto;
              }

              #statusFilter option {
                padding: 2px 4px;
              }

              /* Make header checkbox larger */
              #selectAll {
                width: 1rem;
                /* Adjust width */
                height: 1rem;
                /* Adjust height */
                vertical-align: middle;
                margin: 0;
              }

              .row-checkbox {
                width: 1rem;
                height: 1rem;
              }


              #studentFilterForm #statusFilterInput {
                width: 150px !important;
                max-width: 150px !important;
              }

              #statusFilterInput:hover,
              #statusFilterInput:focus {
                border-color: #1877F2 !important;
                box-shadow: 0 0 0 0.25rem rgba(24, 119, 242, 0.25) !important;
                outline: none;
                /* prevent default outline */
              }

              /* Match 生徒ステータス exactly to table header text */
              #studentStatusFilter .filter-label {
                color: #000 !important;
                font-weight: 600 !important;
                opacity: 1 !important;
              }


              .filter-label-text {
                color: black;
                /* same as input text */

              }

              #downloadBtn {
                margin-left: 6rem;
                /* pushes it to the right */
                margin-right: 0;
                /* moves slightly inward */
              }

              #downloadBtn {
                background-color: #0B5ED7;
                border-color: #0B5ED7;
              }

              #downloadBtn:hover {
                background-color: #0B5ED7;
                border-color: #0B5ED7;
              }

              .table thead tr:last-child th {
                font-size: 0.9rem;
                color: black;
                background-color: #B4D6FA;
                vertical-align: middle;
                border-bottom: 2px solid #dee2e6;
              }


              .table thead tr th {
                font-size: 0.85rem;

                font-weight: 600;

                text-align: center;

                white-space: nowrap;

              }


              .table thead tr:nth-of-type(3) th {
                text-align: center;
                vertical-align: middle;
              }

              .table tbody td {
                text-align: center;
                vertical-align: middle;
              }


              .table thead tr:last-child th:nth-child(1) {
                width: 3%;
              }

              .table thead tr:last-child th:nth-child(2) {
                width: 5%;
              }


              .table thead tr:last-child th:nth-child(3) {
                width: 8%;
              }

              .table thead tr:last-child th:nth-child(4) {
                width: 5%;
              }


              .table thead tr:last-child th:nth-child(5) {
                width: 10%;
              }

              .table thead tr:last-child th:nth-child(6) {
                width: 10%;
              }

              .table thead tr:last-child th:nth-child(7) {
                width: 10%;
              }


              .table thead tr:last-child th:nth-child(8) {
                width: 12%;
              }


              .table thead tr:last-child th:nth-child(9) {
                width: 12%;
              }


              .table thead tr:last-child th:nth-child(10) {
                width: 27%;
              }


              .table thead tr:last-child th:nth-child(1),
              .table thead tr:last-child th:nth-child(2),
              .table thead tr:last-child th:nth-child(3),
              .table thead tr:last-child th:nth-child(4),
              .table thead tr:last-child th:nth-child(5),
              .table thead tr:last-child th:nth-child(6),
              .table thead tr:last-child th:nth-child(7),
              .table thead tr:last-child th:nth-child(8),
              .table thead tr:last-child th:nth-child(10) {
                width: 50px;

              }


              .table tbody tr {
                background-color: #B4D6FA;
              }


              .table tbody tr:hover {
                background-color: #9ac2f8;
              }


              .table tbody tr:has(td[colspan="10"]) {
                background-color: white !important;
              }



              .action-icon {
                cursor: pointer;
                padding: 0 0.25rem;
                transition: color 0.2s;
              }

              .action-icon.edit {
                color: #0d6efd;
              }

              .action-icon.detail {
                color: #198754;
              }

              .action-icon.delete {
                color: #dc3545;
              }

              .action-icon.edit:hover {
                color: #0a58ca;
              }

              .action-icon.detail:hover {
                color: #146c43;
              }

              .action-icon.delete:hover {
                color: #bd2130;
              }


              .action-icon {
                padding: 0 0.15rem !important;
                font-size: 0.9rem;
              }


              .table-wrapper {
                padding: 1rem;
                border: 1px transparent;
                border-radius: 5px;
                background-color: transparent;
              }

              .admin-title {
                font-size: 1.8rem;
                font-weight: 800;
                color: #212529;
                letter-spacing: -0.5px;
              }

              #pagination {
                background-color: white !important;
                padding: 0;
                border-top: none;
              }

              /* FORCE same size as form-control-sm */
              #statusFilterInput {
                width: 150px !important;
                height: 31px !important;
                /* EXACT Bootstrap-sm height */
                padding: 0.25rem 2rem 0.25rem 0.5rem !important;
                font-size: 0.85rem !important;
                line-height: 1.5 !important;
                border-radius: 0.375rem !important;
                box-sizing: border-box !important;
              }
            </style>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

          </head>

          <body class="p-0 m-0">

            <section class="student-management glass-panel">

              <section class="student-management glass-panel">



                <div class="page-wrapper py-4 py-md-5 px-3 px-md-5">
                  <div class="page-header mb-3">
                    <div class="d-flex align-items-center gap-3">
                      <button class="btn btn-light btn-icon d-lg-none" type="button" aria-label="Toggle sidebar"
                        data-sidebar-toggle>
                        <i class="fas fa-bars fs-4"></i>
                      </button>
                      <div>
                        <p class="text-uppercase text-muted small fw-semibold mb-1">生徒情報管理システム</p>
                        <h1 class="mb-0" style="color: #0A58A0; font-weight: 600; font-size: 1.8rem;">
                          生徒情報一覧画面
                        </h1>
                      </div>
                    </div>
                  </div>

                  <!-- TABLE CONTENT CONTINUES BELOW -->


                  <div class="table-wrapper p-1"
                    style="border:1px solid transparent; border-radius:5px; background-color:transparent;">
                    <div class="table-responsive me-3">
                      <table class="table data-table align-middle" id="studentTable">
                        <thead>


                          <tr class="filter-row">
                            <th colspan="10" class="p-3">
                              <form th:action="@{/students}" method="get" id="studentFilterForm">
                                <div class="filter-control-group checkbox-group">
                                  <span style="font-size: 16px;">全て選択</span>
                                  <input type="checkbox" id="selectAll" class="form-check-input" />
                                </div>
                                <div class="filter-control-group">
                                  <span style="font-size: 16px;">名前で検索</span>
                                  <input type="text" name="nameSearch" th:value="${nameSearch}"
                                    class="form-control form-control-sm" id="nameSearchInput" placeholder="名前検索" />
                                </div>
                                <div class="filter-control-group" id="studentStatusWrapper">
                                  <div id="studentStatusFilter">
                                    <div class="filter-control-group">
                                      <label class="filter-label">生徒ステータス</label>

                                      <div class="multiselect-wrapper">
                                        <input type="text" id="statusFilterInput" class="multiselect-input"
                                          value="ステータス選択" readonly>

                                        <span class="dropdown-arrow">▼</span>

                                        <div id="statusDropdownList" class="multiselect-dropdown">
                                          <label><input type="checkbox" class="status-option" value="在校"> 在校</label>
                                          <label><input type="checkbox" class="status-option" value="卒業"> 卒業</label>
                                          <label><input type="checkbox" class="status-option" value="途中退校"> 途中退校</label>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <button type="button" id="downloadBtn"
                                    class="btn btn-success btn-sm px-4 fw-bold text-nowrap">
                                    ↓ダウンロード
                                  </button>

                                  <button type="submit" style="display: none;"></button>
                                  <input type="hidden" name="status" id="hiddenStatus" />

                              </form>
                            </th>
                          </tr>

                          <tr>
                            <th scope="col" style="width: 50px;">生徒ID</th>
                            <th scope="col" style="width: 100px;">名前</th>
                            <th scope="col" style="width: 80px;">性別</th>
                            <th scope="col" style="width: 100px;">電話番号</th>
                            <th scope="col" style="width: 100px;">希望職種</th>
                            <th scope="col" style="width: 80px;">ステータス</th>
                            <th scope="col" style="width: 100px;">支払予定日</th>
                            <th scope="col" style="width: 100px;">支払実績日</th>
                            <th scope="col" style="width: 120px;">動作機能</th>
                          </tr>
                        </thead>


                        <tbody id="studentTableBody" th:if="${students != null}">
                          <tr th:each="student : ${students}">
                            <td class="id-cell">
                              <label class="d-flex align-items-center justify-content-center gap-1 m-0">
                                <input class="form-check-input row-checkbox" type="checkbox" th:value="${student.id}">
                                <span th:text="${student.id}"></span>
                              </label>
                            </td>

                            <td th:text="${student.studentName}"></td>
                            <td th:text="${student.gender}"></td>
                            <td th:text="${student.phoneNumber}"></td>
                            <td th:text="${student.desiredJobType}"></td>
                            <td th:text="${student.status}"></td>
                            <td th:text="${student.paymentDueDate}"></td>
                            <td th:text="${student.paymentDate}"></td>
                            <td class="action-cell">
                              <div class="d-flex flex-nowrap justify-content-center gap-0">
                                <a th:href="@{'/students/student-update/' + ${student.id}}" class="action-icon edit"
                                  title="編集">
                                  <i class="bi bi-pencil-square"></i>
                                </a>
                                <a th:href="@{'/students/detail/' + ${student.id}}" class="action-icon detail"
                                  title="明細">
                                  <i class="bi bi-info-circle-fill"></i> 明細
                                </a>
                                <a href="#"
                                  th:onclick="'if(confirm(\'本当に削除しますか？\')) window.location.href=\'/students/delete/' + ${student.id} + '\';'"
                                  class="action-icon delete" title="削除">
                                  <i class="bi bi-trash-fill"></i>
                                </a>
                                </a>
                              </div>
                            </td>
                          </tr>

                          <tr th:if="${students.size() == 0}">
                            <td colspan="10" class="text-center text-muted py-5">
                              生徒情報がありません。サーバーからのデータ読み込みを待機しています。
                            </td>
                          </tr>
                        </tbody>

                      </table>
                    </div>
                    <div id="pagination" class="d-flex justify-content-center mt-3"></div>

              </section>


              <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

              <script>document.addEventListener("DOMContentLoaded", function () {
                  const downloadBtn = document.getElementById("downloadBtn");
                  const statusFilter = document.querySelector("#statusFilter");

                  downloadBtn.addEventListener("click", function (e) {
                    const selected = Array.from(statusFilter.selectedOptions).map(o => o.value).join(",");
                    downloadBtn.href = `/students/export?nameSearch=${nameSearchInput.value}&status=${selected}`;
                  });
                });


                document.addEventListener('DOMContentLoaded', function () {

                  new TomSelect("#statusFilter", {
                    plugins: ['remove_button'],
                    persist: false,
                    create: false,
                    allowEmptyOption: true,
                    placeholder: "ステータス選択",
                  });
                });

                document.addEventListener('DOMContentLoaded', function () {

                  const selectAll = document.getElementById('selectAll');
                  const checkboxesContainer = document.getElementById('studentTableBody');
                  const statusFilter = document.getElementById('statusFilter');
                  const filterForm = document.getElementById('studentFilterForm');
                  const nameSearchInput = document.getElementById('nameSearchInput');


                  selectAll.addEventListener('change', function (e) {
                    const checkboxes = checkboxesContainer.querySelectorAll('.row-checkbox');
                    checkboxes.forEach(checkbox => {
                      checkbox.checked = e.target.checked;
                    });
                  });


                  statusFilter.addEventListener('change', function () {
                    filterForm.submit();
                  });


                  nameSearchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                      e.preventDefault();
                      filterForm.submit();
                    }
                  });
                });
              </script>

              <script>
                document.addEventListener("DOMContentLoaded", function () {
                  const rows = Array.from(document.querySelectorAll("#studentTableBody tr"))
                    .filter(r => !r.querySelector("td[colspan]"));

                  const rowsPerPage = 10;
                  let currentPage = 1;

                  function displayPage(page) {
                    currentPage = page;

                    const start = (page - 1) * rowsPerPage;
                    const end = start + rowsPerPage;

                    rows.forEach((row, index) => {
                      row.style.display = index >= start && index < end ? "" : "none";
                    });

                    renderPagination();
                  }

                  function renderPagination() {
                    const pageCount = Math.ceil(rows.length / rowsPerPage);
                    const paginationDiv = document.getElementById("pagination");
                    paginationDiv.innerHTML = "";


                    function createBtn(text, page, disabled = false, active = false) {
                      const btn = document.createElement("button");
                      btn.textContent = text;

                      btn.className = `btn btn-sm mx-1 ${active ? "btn-primary" : "btn-outline-primary"
                        }`;

                      btn.disabled = disabled;

                      if (!disabled) {
                        btn.addEventListener("click", () => displayPage(page));
                      }

                      paginationDiv.appendChild(btn);
                    }

                    createBtn("<<", 1, currentPage === 1);

                    createBtn("<", currentPage - 1, currentPage === 1);

                    let start = currentPage - 2;
                    let end = currentPage + 2;

                    if (start < 1) {
                      start = 1;
                      end = Math.min(5, pageCount);
                    }

                    if (end > pageCount) {
                      end = pageCount;
                      start = Math.max(1, pageCount - 4);
                    }

                    for (let i = start; i <= end; i++) {
                      createBtn(i, i, false, i === currentPage);
                    }

                    createBtn(">", currentPage + 1, currentPage === pageCount);

                    createBtn(">>", pageCount, currentPage === pageCount);
                  }

                  displayPage(1);
                });

                document.addEventListener("DOMContentLoaded", function () {
                  const downloadBtn = document.getElementById("downloadBtn");

                  downloadBtn.addEventListener("click", async function () {
                    try {
                      const nameSearch = document.getElementById("nameSearchInput").value;
                      const status = Array.from(document.querySelectorAll(".status-option"))
                        .filter(cb => cb.checked)
                        .map(cb => cb.value)
                        .join(",");

                      const selectedIds = Array.from(document.querySelectorAll(".row-checkbox"))
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                      // Build query parameters
                      const params = new URLSearchParams();
                      if (selectedIds.length > 0) params.append("ids", selectedIds.join(","));
                      if (nameSearch) params.append("nameSearch", nameSearch);
                      if (status) params.append("status", status);

                      // Fetch student data from backend
                      const response = await fetch(`/students/export?${params.toString()}`);
                      const data = await response.json();

                      if (!data || data.length === 0) {
                        alert("エクスポートするデータがありません！");
                        return;
                      }

                      // Full headers
                      const headers = [
                        // Student Info
                        "生徒ID", "名前", "名前(カタカナ)", "生年月日", "性別", "現住所", "出身地住所",
                        "連絡先(TEL,Viber)", "父親名", "パスポート番号", "国民ID番号",
                        "現在のJLPT合格レベル", "希望職種", "その他希望職種", "日本渡航経験",
                        "COE申請経験", "宗教", "その他宗教", "タバコ", "お酒", "入れ墨",
                        "授業料支払予定日", "寮があれば入りたい", "その他メモ（自由形式）", "授業料支払実績日",
                        "学校登録日", "生徒の授業ステータス",

                        // N5 Class
                        "所属クラス", "担当教師", "出席", "日本語テスト結果1", "日本語テスト結果2", "日本語テスト結果3", "日本語テスト結果4", "教師所感",
                        "所属クラス2", "担当教師 3", "出席率4", "日本語テスト結果", "教師所感5", "所属クラス6",
                        "担当教師 7", "出席率8", "日本語テスト結果9", "教師所感10",

                        // N4 Class
                        "所属クラス11", "担当教師 12", "出席率13", "日本語テスト結果14", "教師所感15",
                        "所属クラス16", "担当教師 17", "出席率18", "日本語テスト結果１19", "日本語テスト結果２20", "日本語テスト結果３21",
                        "日本語テスト結果４22", "教師所感23", "所属クラス24", "担当教師 25", "出席率26", "日本語テスト結果27", "教師所感28",
                        "所属クラス29", "担当教師 30", "出席率31", "日本語テスト結果32", "教師所感33",

                        // Interview / JLPT
                        "所属クラス34", "担当教師 35", "出席率36", "日本語テスト結果37", "教師所感38",
                        "合格した日本語ラベル",

                        // Interview Notes
                        "一回目面接メモ", "二回目面接メモ", "三回目面接メモ"
                      ];

                      // Map student data to rows
                      const rows = data.map(student => [
                        student.id,
                        student.studentName,
                        student.nameInJapanese,
                        student.dateOfBirth,
                        student.gender,
                        student.currentLivingAddress,
                        student.homeTownAddress,
                        student.contactViber,
                        student.fatherName,
                        student.passportNumber,
                        student.nationalID,
                        student.currentJapanLevel,
                        student.desiredJobType,
                        student.otherDesiredJobType,
                        student.japanTravelExperience,
                        student.coeApplicationExperience,
                        student.religion,
                        student.otherReligion,
                        student.isSmoking ? "吸う" : "吸わない",
                        student.isAlcoholDrink ? "飲む" : "飲まない",
                        student.haveTatto ? "有" : "無",
                        student.schedulePaymentTutionDate,
                        student.hostelPreference,
                        student.memoNotes,
                        student.actualTutionPaymentDate,
                        student.enrolledDate,
                        student.status,
                        // N5 Class
                        student.n5ClassName,
                        student.n5ClassTeacher,
                        student.n5ClassAttendance,
                        student.n5ClassTestResult1,
                        student.n5ClassTestResult2,
                        student.n5ClassTestResult3,
                        student.n5ClassTestResult4,
                        student.n5ClassFeedback,
                        student.n5Class2Name,
                        student.n5Class2Teacher,
                        student.n5Class2AttendanceRate,
                        student.n5Class2TestResult,
                        student.n5Class2Feedback,
                        student.n5Class3Name,
                        student.n5Class3Teacher,
                        student.n5Class3AttendanceRate,
                        student.n5Class3TestResult,
                        student.n5Class3Feedback,
                        // N4 Class
                        student.n4Class1Name,
                        student.n4Class1Teacher,
                        student.n4Class1AttendanceRate,
                        student.n4Class1TestResult1,
                        student.n4Class1Feedback,
                        student.n4Class2Name,
                        student.n4Class2Teacher,
                        student.n4Class2AttendanceRate,
                        student.n4Class2TestResult1,
                        student.n4Class2TestResult2,
                        student.n4Class2TestResult3,
                        student.n4Class2TestResult4,
                        student.n4Class2Feedback,
                        student.n4Class3Name,
                        student.n4Class3Teacher,
                        student.n4Class3AttendanceRate,
                        student.n4Class3TestResult,
                        student.n4Class3Feedback,
                        student.n4Class4Name,
                        student.n4Class4Teacher,
                        student.n4Class4AttendanceRate,
                        student.n4Class4TestResult,
                        student.n4Class4Feedback,
                        // Interview / JLPT
                        student.interviewClassName,
                        student.interviewTeacher,
                        student.interviewAttendanceRate,
                        student.interviewTestResult,
                        student.interviewFeedback,
                        student.passedHighestJLPTLevel,
                        // Interview Notes
                        student.interviewNote1,
                        student.interviewNote2,
                        student.interviewNote3
                      ]);

                      // Create workbook and worksheet
                      const wb = XLSX.utils.book_new();
                      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);

                      // Set column widths
                      ws['!cols'] = headers.map(h => ({ wch: 20 }));



                      // Color headers by section
                      const colorMap = [
                        { start: 0, end: 27, bg: "FFFF99" },    // Student Info - Yellow
                        { start: 28, end: 43, bg: "99CCFF" },   // N5 Class - Light Blue
                        { start: 44, end: 59, bg: "99FF99" },   // N4 Class - Light Green
                        { start: 60, end: 63, bg: "FFCC99" }    // Interview & JLPT - Orange
                      ];

                      colorMap.forEach(section => {
                        for (let c = section.start; c <= section.end; c++) {
                          const cellAddress = XLSX.utils.encode_cell({ r: 0, c: c });
                          if (!ws[cellAddress]) continue;
                          ws[cellAddress].s = {
                            fill: { fgColor: { rgb: section.bg } },
                            font: { bold: true },
                            alignment: { horizontal: "center" }
                          };
                        }
                      });

                      XLSX.utils.book_append_sheet(wb, ws, "Students");
                      XLSX.writeFile(wb, "students_full.xlsx");

                    } catch (err) {
                      console.error(err);
                      alert("XLSXのエクスポートに失敗しました！");
                    }
                  });
                });



                document.addEventListener("DOMContentLoaded", () => {
                  const statusInput = document.getElementById("statusFilterInput");
                  const dropdown = document.getElementById("statusDropdownList");
                  const statusCheckboxes = document.querySelectorAll(".status-option");
                  const nameInput = document.getElementById("nameSearchInput");
                  const form = document.getElementById("studentFilterForm");
                  const hiddenStatus = document.getElementById("hiddenStatus");

                  // Restore saved statuses and name
                  const savedStatuses = localStorage.getItem("savedStatuses");
                  const savedName = localStorage.getItem("savedName");

                  if (savedStatuses && savedStatuses.length > 0) {
                    const statusArray = savedStatuses.split(",");
                    statusCheckboxes.forEach(cb => {
                      if (statusArray.includes(cb.value)) cb.checked = true;
                    });
                    statusInput.value = statusArray.join(", ");
                    hiddenStatus.value = savedStatuses;
                  }

                  if (savedName) {
                    nameInput.value = savedName;
                  }

                  // Function to update status input background
                  function updateStatusInputBg() {
                    const anyChecked = Array.from(statusCheckboxes).some(cb => cb.checked);
                    statusInput.style.backgroundColor = anyChecked ? "#E8F0FE" : "white";
                  }

                  // Function to update name input background
                  function updateNameInputBg() {
                    nameInput.style.backgroundColor = nameInput.value.trim() !== "" ? "#E8F0FE" : "white";
                  }

                  // Call on page load
                  updateStatusInputBg();
                  updateNameInputBg();

                  // Update status input background on checkbox change
                  statusCheckboxes.forEach(cb => cb.addEventListener("change", () => {
                    const selected = Array.from(statusCheckboxes)
                      .filter(c => c.checked)
                      .map(c => c.value);

                    statusInput.value = selected.length > 0 ? selected.join(", ") : "ステータス選択";
                    hiddenStatus.value = selected.join(",");

                    localStorage.setItem("savedStatuses", selected.join(", "));
                    updateStatusInputBg();
                  }));

                  // Update name input background on typing
                  nameInput.addEventListener("input", () => {
                    localStorage.setItem("savedName", nameInput.value);
                    updateNameInputBg();
                  });

                  // Toggle dropdown
                  statusInput.addEventListener("click", () => {
                    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
                  });

                  // Submit form
                  function submitFilterForm() {
                    form.submit();
                  }

                  // Handle Enter key
                  [statusInput, nameInput].forEach(input => {
                    input.addEventListener("keydown", e => {
                      if (e.key === "Enter") {
                        e.preventDefault();
                        submitFilterForm();
                      }
                    });
                  });

                  // Close dropdown when clicking outside
                  document.addEventListener("click", e => {
                    if (!e.target.closest(".multiselect-wrapper")) {
                      dropdown.style.display = "none";
                    }
                  });
                });

              </script>
              </script>


</html>