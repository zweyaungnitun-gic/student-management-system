<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!--Student-->
<!-- Head fragment -->
<!-- 1292025 -->

<head th:replace="~{layouts/admin-layout :: head(pageTitle=${'Students | Admin Dashboard'})}"></head>

<body>
  <div class="dashboard-layout">

    <!-- Sidebar -->
    <th:block th:replace="~{layouts/admin-layout :: sidebar(currentPage=${'students'})}"></th:block>

    <div class="sidebar-overlay d-lg-none" data-sidebar-toggle></div>

    <!-- Main Section -->
    <div class="dashboard-main" style="width:100%; height:100%;">

      <!-- Full-width area (page-wrapper removed) -->
      <div class="dashboard-content" style="padding:0; margin:0; width:100%;">

        <!-- Use container-fluid so it expands full width beside sidebar -->
        <main class="container-fluid flex-grow-1" style="padding:0; margin:0;">

          <head>
            <meta charset="utf-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1" />
            <title>生徒情報管理システム</title>

            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />


            <link rel="stylesheet"
              href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

            <style>
              body {
                background-color: transparent;
                padding: 0;
                margin: 0;
                min-height: 100vh;
                width: 100vw;
              }


              .table tbody td a.action-icon {
                display: inline-flex;
                align-items: center;
                margin-right: 8px;
                white-space: nowrap;
              }


              .student-management {
                padding: 0;
              }

              .table-responsive {
                background-color: transparent;
                border-radius: 0;
                box-shadow: none !important;
                width: 100%;
              }

              /* Make action icons square with pagination color style */
              .action-icon {
                display: inline-flex;
                /* flex for centering */
                align-items: center;
                /* vertical center */
                justify-content: center;
                /* horizontal center */
                width: 36px;
                /* square width */
                height: 36px;
                /* square height */
                margin: 0 2px;
                /* spacing between buttons */
                border-radius: 0.25rem;
                /* optional rounded corners */
                font-size: 1rem;
                color: white;
                /* text/icon color */
                text-decoration: none;
                transition: background-color 0.2s, color 0.2s;
              }

              /* Make action icons square with background behind icon */
              .action-icon {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                margin: 0 2px;
                border-radius: 0.25rem;
                font-size: 1rem;
                text-decoration: none;
                transition: background-color 0.2s;
                color: white;
                /* Icon color stays visible */
              }


              .table {
                margin-bottom: 0;
                border-radius: 0;
                overflow: hidden;
                width: 100%;
                table-layout: auto;
              }


              .title-header-row th {
                background: #0F6CBD;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0 0 0 0;
                border-bottom: 1px solid #0a58a0;
              }

              .title-header-row h4 {
                color: white;
                margin-bottom: 0 !important;
              }

              .filter-row th {
                background: white;
                color: black;
                padding-left: 0.25rem !important;
                border-radius: 0;
                border-bottom: 1px solid #dee2e6;
              }




              .filter-row th span {
                color: black;
              }

              #studentFilterForm {
                display: flex;
                /* Arrange children in a row */
                flex-wrap: wrap;
                /* Wrap if needed */
                align-items: center;
                /* Vertically align everything */
                gap: 2rem;
                /* Space between controls */
                margin: 0;
                padding: 10px;
              }

              .filter-control-group {
                display: flex;
                align-items: center;
                gap: 0.25rem;
              }

              /* Make checkbox appear after label text */
              .filter-control-group.checkbox-group {
                flex-direction: row-reverse;
                /* Label first, checkbox after */
              }

              /* Inputs and select same height */
              .filter-control-group input[type="text"],
              .filter-control-group select {
                height: calc(1.5em + 0.5rem + 2px);
              }

              #downloadBtn {
                margin-left: auto;
                /* pushes it to the right */
                margin-right: 0;
                /* moves slightly inward */
              }

              .table thead tr:last-child th {
                font-size: 0.9rem;
                color: black;
                background-color: #B4D6FA;
                vertical-align: middle;
                border-bottom: 2px solid #dee2e6;
              }


              .table thead tr th {
                font-size: 0.85rem;

                font-weight: 600;

                text-align: center;

                white-space: nowrap;

              }


              .table thead tr:nth-of-type(3) th {
                text-align: center;
                vertical-align: middle;
              }

              .table tbody td {
                text-align: center;
                vertical-align: middle;
              }


              .table thead tr:last-child th:nth-child(1) {
                width: 3%;
              }

              .table thead tr:last-child th:nth-child(2) {
                width: 5%;
              }


              .table thead tr:last-child th:nth-child(3) {
                width: 8%;
              }

              .table thead tr:last-child th:nth-child(4) {
                width: 5%;
              }


              .table thead tr:last-child th:nth-child(5) {
                width: 10%;
              }

              .table thead tr:last-child th:nth-child(6) {
                width: 10%;
              }

              .table thead tr:last-child th:nth-child(7) {
                width: 10%;
              }


              .table thead tr:last-child th:nth-child(8) {
                width: 12%;
              }


              .table thead tr:last-child th:nth-child(9) {
                width: 12%;
              }


              .table thead tr:last-child th:nth-child(10) {
                width: 27%;
              }


              .table thead tr:last-child th:nth-child(1),
              .table thead tr:last-child th:nth-child(2),
              .table thead tr:last-child th:nth-child(3),
              .table thead tr:last-child th:nth-child(4),
              .table thead tr:last-child th:nth-child(5),
              .table thead tr:last-child th:nth-child(6),
              .table thead tr:last-child th:nth-child(7),
              .table thead tr:last-child th:nth-child(8),
              .table thead tr:last-child th:nth-child(10) {
                width: 50px;

              }


              .table tbody tr {
                background-color: #B4D6FA;
              }


              .table tbody tr:hover {
                background-color: #9ac2f8;
              }


              .table tbody tr:has(td[colspan="10"]) {
                background-color: white !important;
              }



              .action-icon {
                cursor: pointer;
                padding: 0 0.25rem;
                transition: color 0.2s;
              }

              .action-icon.edit {
                color: #0d6efd;
              }

              .action-icon.detail {
                color: #198754;
              }

              .action-icon.delete {
                color: #dc3545;
              }

              .action-icon.edit:hover {
                color: #0a58ca;
              }

              .action-icon.detail:hover {
                color: #146c43;
              }

              .action-icon.delete:hover {
                color: #bd2130;
              }





              .action-icon {
                padding: 0 0.15rem !important;
                font-size: 0.9rem;
              }


              .table-wrapper {
                padding: 1rem;
                border: 1px transparent;
                border-radius: 5px;
                background-color: transparent;
              }


              #downloadBtn {
                background-color: #0F6CBD;
                border-color: #0F6CBD;
              }

              #downloadBtn:hover {
                background-color: #0a58a0;
                border-color: #0a58a0;
              }

              #statusFilter[multiple] {
                height: 32px !important;
                overflow-y: auto;
              }

              #statusFilter option {
                padding: 2px 4px;
              }

              /* Make header checkbox larger */
              #selectAll {
                width: 1rem;
                /* Adjust width */
                height: 1rem;
                /* Adjust height */
                vertical-align: middle;
                margin: 0;
              }

              .row-checkbox {
                width: 1rem;
                height: 1rem;
              }

              .admin-title {
                font-size: 1.8rem;
                font-weight: 800;
                color: #212529;
                letter-spacing: -0.5px;
              }


              #nameSearchInput:hover {
                border-color: #1877F2 !important;
                box-shadow: 0 0 0 0.25rem rgba(24, 119, 242, 0.25) !important;
              }

              #pagination {
                background-color: white !important;
                padding: 0;
                border-top: none;
              }
            </style>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


          </head>


          <body class="p-0 m-0">

            <section class="student-management glass-panel">


              <div class="mb-0">
                <div>
                  <p class="text-uppercase text-muted small fw-semibold mb-1 fs-4">生徒情報管理システム</p>

                </div>
              </div>

              <div class="table-wrapper p-3"
                style="border:1px solid transparent; border-radius:5px; background-color:transparent;">
                <div class="table-responsive me-3">
                  <table class="table data-table align-middle" id="studentTable">
                    <thead>


                      <tr class="filter-row">
                        <th colspan="10" class="p-3">
                          <form th:action="@{/students}" method="get" id="studentFilterForm" style="overflow: hidden;">
                            <div class="filter-control-group checkbox-group">
                              <span style="font-size: 16px;">全て選択</span>
                              <input type="checkbox" id="selectAll" class="form-check-input" />
                            </div>
                            <div class="filter-control-group">
                              <span style="font-size: 16px;">名前で検索</span>
                              <input type="text" name="nameSearch" th:value="${nameSearch}"
                                class="form-control form-control-sm" id="nameSearchInput" placeholder="名前検索" />
                            </div>
                            <div class="filter-control-group">
                              <span style="font-size: 16px;">生徒ステータス</span>
                              <select name="status" id="statusFilter" multiple class="form-select form-select-sm">
                                <option value="在校">在校</option>
                                <option value="卒業">卒業</option>
                                <option value="途中退校">途中退校</option>
                              </select>
                            </div>
                            <a id="downloadBtn"
                              th:href="@{/students/download(nameSearch=${nameSearch}, status=${statusFilter})}"
                              class="btn btn-success btn-sm px-4 fw-bold text-nowrap">↓ダウンロード</a>


                            <button type="submit" style="display: none;"></button>
                            <input type="hidden" name="status" id="hiddenStatus" />

                          </form>
                        </th>
                      </tr>


                      <tr>

                        <th scope="col" style="width: 50px;">生徒ID</th>
                        <th scope="col" style="width: 100px;">名前</th>
                        <th scope="col" style="width: 80px;">性別</th>
                        <th scope="col" style="width: 100px;">電話番号</th>
                        <th scope="col" style="width: 100px;">希望職種</th>
                        <th scope="col" style="width: 80px;">ステータス</th>
                        <th scope="col" style="width: 100px;">支払予定日</th>
                        <th scope="col" style="width: 100px;">支払実績日</th>
                        <th scope="col" style="width: 120px;">動作機能</th>
                      </tr>
                    </thead>


                    <tbody id="studentTableBody" th:if="${students != null}">
                      <tr th:each="student : ${students}">
                        <td class="id-cell">
                          <label class="d-flex align-items-center justify-content-center gap-1 m-0">
                            <input class="form-check-input row-checkbox" type="checkbox" th:value="${student.id}">
                            <span th:text="${student.id}"></span>
                          </label>
                        </td>

                        <td th:text="${student.studentName}"></td>
                        <td th:text="${student.gender}"></td>
                        <td th:text="${student.phoneNumber}"></td>
                        <td th:text="${student.desiredJobType}"></td>
                        <td th:text="${student.status}"></td>
                        <td th:text="${student.paymentDueDate}"></td>
                        <td th:text="${student.paymentDate}"></td>
                        <td class="action-cell">
                          <div class="d-flex flex-nowrap justify-content-center gap-0">
                            <a th:href="@{'/students/student-update/' + ${student.id}}" class="action-icon edit" title="編集">
                              <i class="bi bi-pencil-square"></i>
                            </a>
                            <a th:href="@{'/students/detail/' + ${student.id}}" class="action-icon detail" title="明細">
                              <i class="bi bi-info-circle-fill"></i> 明細
                            </a>
                            <a href="#"
                              th:onclick="'if(confirm(\'本当に削除しますか？\')) window.location.href=\'/students/delete/' + ${student.id} + '\';'"
                              class="action-icon delete" title="削除">
                              <i class="bi bi-trash-fill"></i>
                            </a>

                            </a>

                          </div>
                        </td>

                      </tr>

                      <tr th:if="${students.size() == 0}">
                        <td colspan="10" class="text-center text-muted py-5">
                          生徒情報がありません。サーバーからのデータ読み込みを待機しています。
                        </td>
                      </tr>
                    </tbody>




                  </table>
                </div>
                <div id="pagination" class="d-flex justify-content-center mt-3"></div>

            </section>


            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

            <script>document.addEventListener("DOMContentLoaded", function () {
                const downloadBtn = document.getElementById("downloadBtn");
                const statusFilter = document.querySelector("#statusFilter");

                downloadBtn.addEventListener("click", function (e) {
                  const selected = Array.from(statusFilter.selectedOptions).map(o => o.value).join(",");
                  downloadBtn.href = `/students/download?nameSearch=${nameSearchInput.value}&status=${selected}`;
                });
              });




              document.addEventListener('DOMContentLoaded', function () {

                new TomSelect("#statusFilter", {
                  plugins: ['remove_button'],
                  persist: false,
                  create: false,
                  allowEmptyOption: true,
                  placeholder: "ステータス選択",
                });

              });
              document.addEventListener('DOMContentLoaded', function () {

                const selectAll = document.getElementById('selectAll');
                const checkboxesContainer = document.getElementById('studentTableBody');
                const statusFilter = document.getElementById('statusFilter');
                const filterForm = document.getElementById('studentFilterForm');
                const nameSearchInput = document.getElementById('nameSearchInput');


                selectAll.addEventListener('change', function (e) {
                  const checkboxes = checkboxesContainer.querySelectorAll('.row-checkbox');
                  checkboxes.forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                  });
                });


                statusFilter.addEventListener('change', function () {
                  filterForm.submit();
                });


                nameSearchInput.addEventListener('keypress', function (e) {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    filterForm.submit();
                  }
                });
              });
            </script>

            <script>
              document.addEventListener("DOMContentLoaded", function () {
                const rows = Array.from(document.querySelectorAll("#studentTableBody tr"))
                  .filter(r => !r.querySelector("td[colspan]"));

                const rowsPerPage = 10;
                let currentPage = 1;

                function displayPage(page) {
                  currentPage = page;

                  const start = (page - 1) * rowsPerPage;
                  const end = start + rowsPerPage;

                  rows.forEach((row, index) => {
                    row.style.display = index >= start && index < end ? "" : "none";
                  });

                  renderPagination();
                }

                function renderPagination() {
                  const pageCount = Math.ceil(rows.length / rowsPerPage);
                  const paginationDiv = document.getElementById("pagination");
                  paginationDiv.innerHTML = "";


                  function createBtn(text, page, disabled = false, active = false) {
                    const btn = document.createElement("button");
                    btn.textContent = text;

                    btn.className = `btn btn-sm mx-1 ${active ? "btn-primary" : "btn-outline-primary"
                      }`;

                    btn.disabled = disabled;

                    if (!disabled) {
                      btn.addEventListener("click", () => displayPage(page));
                    }

                    paginationDiv.appendChild(btn);
                  }


                  createBtn("<<", 1, currentPage === 1);

                  createBtn("<", currentPage - 1, currentPage === 1);

                  let start = currentPage - 2;
                  let end = currentPage + 2;

                  if (start < 1) {
                    start = 1;
                    end = Math.min(5, pageCount);
                  }

                  if (end > pageCount) {
                    end = pageCount;
                    start = Math.max(1, pageCount - 4);
                  }

                  for (let i = start; i <= end; i++) {
                    createBtn(i, i, false, i === currentPage);
                  }

                  createBtn(">", currentPage + 1, currentPage === pageCount);

                  createBtn(">>", pageCount, currentPage === pageCount);
                }

                displayPage(1);
              });
            </script>

</html>